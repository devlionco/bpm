define(["core/fragment","core/ajax","core/modal_factory","core/modal_events"],function(a,b,c,d){var e={modal:null,responseModal:null,contextid:null,appendurl:!1,init:function(){c.create({type:c.types.DEFAULT,title:M.util.get_string("pluginname","block_messageteacher")}).then(function(a){e.responseModal=a}),c.create({type:c.types.SAVE_CANCEL,title:M.util.get_string("pluginname","block_messageteacher")}).then(function(a){e.modal=a,e.modal.setLarge(),e.modal.setSaveButtonText(M.util.get_string("send","block_messageteacher")),e.modal.getRoot().on(d.hidden,function(){e.modal.setBody("")}.bind(this)),e.modal.getRoot().on(d.save,function(a){a.preventDefault(),e.modal.getRoot().find("form").submit()}),e.modal.getRoot().on("submit","form",e.submitForm);for(var b=document.querySelectorAll(".messageteacher_link"),c=0;c<b.length;c++)null===e.contextid&&(e.contextid=b[c].parentElement.parentElement.dataset.contextid,e.appendurl=b[c].parentElement.parentElement.dataset.appendurl),b[c].addEventListener("click",e.showForm)})},getForm:function(b){return a.loadFragment("block_messageteacher","message_form",e.contextid,b)},showForm:function(a){a.preventDefault(),e.modal.show(),e.modal.setBody(e.getForm(a.currentTarget.dataset))},submitForm:function(a){a.preventDefault();var c=e.modal.getRoot().find("[name=recipientid]").val(),d=e.modal.getRoot().find("[name=message]").val();e.appendurl&&(d+="\n\n"+e.modal.getRoot().find("[name=referurl]").val()),M.util.js_pending("block_messageteacher_send"),b.call([{methodname:"core_message_send_instant_messages",args:{messages:[{touserid:c,text:d}]},done:function(a){e.modal.hide(),a.msgid===-1?e.responseModal.setBody(a.errormessage):e.responseModal.setBody(M.util.get_string("messagesent","block_messageteacher")),e.responseModal.show(),M.util.js_complete("block_messageteacher_send")},fail:function(a){e.modal.hide(),e.responseModal.setBody(a.message),e.responseModal.show(),M.util.js_complete("block_messageteacher_send")}}])}};return e});